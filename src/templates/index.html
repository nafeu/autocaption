<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>autocaption</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
      :root {
        --color-a: #FFF05A;
        --color-b: #191919;
        --color-c: #FFD25A;
        --color-d: #FFAA5A;
        --color-e: #FF785A;
        --color-bg: var(--color-b);
        --color-fg: var(--color-a);
        --color-muted: var(--color-c);
        --color-accent: var(--color-e);
        --space: 12px;
        --sidebar-width: 320px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Space Mono", monospace;
        background: var(--color-bg);
        color: var(--color-fg);
        min-height: 100vh;
        overflow: hidden;
      }

      .layout {
        display: flex;
        height: 100vh;
      }

      /* —— Left: dropzone + video preview —— */
      .main-pane {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: var(--space);
      }

      .main-pane-center {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        flex: 1;
        min-height: 0;
        width: 100%;
      }

      .dropzone {
        width: 100%;
        max-width: 720px;
        aspect-ratio: 9 / 16;
        max-height: 100%;
        border: 2px dashed var(--color-fg);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: var(--space);
        cursor: pointer;
        transition: border-color 0.2s, background 0.2s;
        background: rgba(255, 240, 90, 0.03);
      }

      .dropzone:hover,
      .dropzone.dragover {
        border-color: var(--color-e);
        background: rgba(255, 120, 90, 0.06);
      }

      .dropzone i {
        font-size: 2.5rem;
        opacity: 0.8;
      }

      .dropzone span {
        font-size: 0.9rem;
        color: var(--color-muted);
      }

      .dropzone input {
        display: none;
      }

      .video-wrap {
        width: 100%;
        max-width: 720px;
        aspect-ratio: 9 / 16;
        max-height: 100%;
        background: #000;
        overflow: hidden;
        display: none;
      }

      .video-wrap.visible {
        display: block;
      }

      .video-wrap video {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }

      .main-pane .status {
        margin-top: var(--space);
        font-size: 0.85rem;
        color: var(--color-muted);
        min-height: 1.2em;
      }

      .main-pane .status.error {
        color: var(--color-e);
      }

      .main-pane .status.loading {
        color: var(--color-c);
      }

      /* —— Right: toolbar —— */
      .sidebar {
        width: var(--sidebar-width);
        flex-shrink: 0;
        background: rgba(0, 0, 0, 0.25);
        border-left: 1px solid rgba(255, 240, 90, 0.15);
        display: flex;
        flex-direction: column;
        padding: var(--space);
        gap: var(--space);
      }

      .sidebar-title {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--color-muted);
        margin-bottom: 4px;
      }

      .vtt-textarea {
        flex: 1;
        min-height: 120px;
        width: 100%;
        padding: var(--space);
        background: var(--color-bg);
        border: 1px solid rgba(255, 240, 90, 0.2);
        color: var(--color-fg);
        font-family: "Space Mono", monospace;
        font-size: 0.8rem;
        resize: none;
        outline: none;
      }

      .vtt-textarea::placeholder {
        color: var(--color-muted);
        opacity: 0.6;
      }

      .vtt-textarea:focus {
        border-color: var(--color-a);
      }

      .actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px var(--space);
        font-family: inherit;
        font-size: 0.85rem;
        font-weight: 700;
        color: var(--color-b);
        background: var(--color-a);
        border: none;
        cursor: pointer;
        transition: background 0.2s, opacity 0.2s;
      }

      .btn:hover {
        background: var(--color-c);
      }

      .btn:active {
        opacity: 0.9;
      }

      .btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }

      .btn i {
        font-size: 0.9rem;
      }

      .btn-secondary {
        background: transparent;
        color: var(--color-fg);
        border: 1px solid rgba(255, 240, 90, 0.4);
      }

      .btn-secondary:hover:not(:disabled) {
        background: rgba(255, 240, 90, 0.1);
        border-color: var(--color-a);
      }

      /* —— Text-based transcript editor —— */
      .transcript-editor-wrap {
        flex: 1;
        min-height: 0;
        display: flex;
        flex-direction: column;
        gap: var(--space);
      }

      .transcript-editor {
        flex: 1;
        min-height: 120px;
        overflow-y: auto;
        padding: var(--space);
        background: var(--color-bg);
        border: 1px solid rgba(255, 240, 90, 0.2);
        font-family: "Space Mono", monospace;
        font-size: 0.85rem;
        line-height: 1.6;
        color: var(--color-fg);
      }

      .transcript-editor:focus {
        outline: none;
        border-color: var(--color-a);
      }

      .transcript-hint {
        font-size: 0.7rem;
        color: var(--color-muted);
        margin-bottom: 4px;
      }

      .transcript-chip {
        display: inline;
        cursor: pointer;
        padding: 2px 4px;
        margin: 0 1px;
        border-radius: 3px;
        transition: background 0.15s, color 0.15s, opacity 0.15s;
      }

      .transcript-chip:hover {
        background: rgba(255, 240, 90, 0.15);
      }

      .transcript-chip.silence {
        color: var(--color-muted);
        font-style: italic;
      }

      .transcript-chip.deleted {
        opacity: 0.5;
        text-decoration: line-through;
        color: var(--color-muted);
      }

      .transcript-chip.deleted:hover {
        background: rgba(255, 120, 90, 0.15);
      }

      .transcript-empty {
        color: var(--color-muted);
        font-style: italic;
      }

      .btn-rerender {
        background: var(--color-e);
        color: var(--color-b);
      }

      .btn-rerender:hover:not(:disabled) {
        background: #ff9060;
      }

      .vtt-raw-wrap {
        margin-top: 4px;
      }

      .vtt-raw-wrap summary {
        cursor: pointer;
        list-style: none;
      }

      .vtt-raw-wrap summary::-webkit-details-marker {
        display: none;
      }

      .vtt-raw-wrap .vtt-textarea {
        margin-top: 6px;
      }
    </style>
  </head>
  <body>
    <div class="layout">
      <main class="main-pane">
        <div class="main-pane-center">
          <div id="dropzone" class="dropzone">
            <input type="file" id="fileInput" accept="video/mp4">
            <i class="fas fa-cloud-upload-alt"></i>
            <span>Drop video here or click to browse</span>
          </div>
          <div id="videoWrap" class="video-wrap">
            <video id="videoPreview" controls></video>
          </div>
        </div>
        <p id="status" class="status" aria-live="polite"></p>
      </main>

      <aside class="sidebar">
        <div class="transcript-editor-wrap">
          <div>
            <div class="sidebar-title">Transcript (text-based editor)</div>
            <p class="transcript-hint" id="transcriptHint">Click a word or … to remove it from the video. Click again to restore.</p>
            <div
              id="transcriptEditor"
              class="transcript-editor"
              tabindex="0"
              role="document"
              aria-label="Transcript editor"
            ></div>
            <div id="transcriptPlaceholder" class="transcript-empty">
              Process a video to see the transcript.
            </div>
          </div>
          <details class="vtt-raw-wrap">
            <summary class="sidebar-title">Raw VTT</summary>
            <textarea
              id="vttEditor"
              class="vtt-textarea"
              placeholder="Generated captions (VTT)…"
              spellcheck="false"
              rows="4"
            ></textarea>
          </details>
          <div class="actions">
            <button type="button" id="rerenderBtn" class="btn btn-rerender" disabled title="Re-render video with removed segments">
              <i class="fas fa-cut"></i> Re-render video
            </button>
            <button type="button" id="reprocessBtn" class="btn btn-secondary" disabled>
              <i class="fas fa-redo-alt"></i> Reprocess video
            </button>
            <button type="button" id="saveVttBtn" class="btn" disabled>
              <i class="fas fa-save"></i> Save VTT
            </button>
          </div>
        </div>
      </aside>
    </div>

    <script>
      const MAX_SIZE_MB = 100;
      const MAX_SIZE = MAX_SIZE_MB * 1024 * 1024;

      const dropzone = document.getElementById("dropzone");
      const fileInput = document.getElementById("fileInput");
      const videoWrap = document.getElementById("videoWrap");
      const videoPreview = document.getElementById("videoPreview");
      const statusEl = document.getElementById("status");
      const vttEditor = document.getElementById("vttEditor");
      const transcriptEditor = document.getElementById("transcriptEditor");
      const transcriptPlaceholder = document.getElementById("transcriptPlaceholder");
      const reprocessBtn = document.getElementById("reprocessBtn");
      const saveVttBtn = document.getElementById("saveVttBtn");
      const rerenderBtn = document.getElementById("rerenderBtn");

      let currentFile = null;
      let currentFilename = "";
      let transcriptSegments = [];
      let deletedIds = new Set();

      function setStatus(msg, type = "") {
        statusEl.textContent = msg;
        statusEl.className = "status" + (type ? " " + type : "");
      }

      function clearStatus() {
        setStatus("");
      }

      function showDropzone() {
        dropzone.style.display = "flex";
        videoWrap.classList.remove("visible");
      }

      function showVideo(url) {
        dropzone.style.display = "none";
        videoWrap.classList.add("visible");
        videoPreview.src = url;
      }

      function validateFile(file) {
        if (!file) return null;
        if (file.type !== "video/mp4") {
          setStatus("Only MP4 files are allowed.", "error");
          return null;
        }
        if (file.size > MAX_SIZE) {
          setStatus(`File must be under ${MAX_SIZE_MB} MB.`, "error");
          return null;
        }
        return file;
      }

      async function processVideo(file) {
        currentFile = file;
        currentFilename = file.name;
        showVideo(URL.createObjectURL(file));
        setStatus("Generating captions…", "loading");
        reprocessBtn.disabled = true;
        saveVttBtn.disabled = true;

        const formData = new FormData();
        formData.append("video", file);

        try {
          const res = await fetch("/process", { method: "POST", body: formData });
          const data = await res.json();

          if (!res.ok) {
            setStatus("Error: " + (data.error || res.statusText), "error");
            return;
          }

          clearStatus();
          await loadVtt(currentFilename);
          await loadTranscript(currentFilename);
          videoPreview.src = "/download/" + data.output_file;
          reprocessBtn.disabled = false;
          saveVttBtn.disabled = false;
        } catch (err) {
          setStatus("Error: " + err.message, "error");
          reprocessBtn.disabled = false;
          saveVttBtn.disabled = false;
        }
      }

      async function loadVtt(filename) {
        try {
          const res = await fetch("/get_vtt/" + encodeURIComponent(filename));
          const data = await res.json();
          if (res.ok) {
            vttEditor.value = data.vtt_content || "";
          }
        } catch (err) {
          setStatus("Could not load captions.", "error");
        }
      }

      function renderTranscript(segments) {
        transcriptSegments = segments || [];
        deletedIds = new Set();
        if (transcriptSegments.length === 0) {
          transcriptPlaceholder.style.display = "block";
          transcriptEditor.style.display = "none";
          transcriptEditor.innerHTML = "";
          rerenderBtn.disabled = true;
          return;
        }
        transcriptPlaceholder.style.display = "none";
        transcriptEditor.style.display = "block";
        transcriptEditor.innerHTML = "";
        transcriptSegments.forEach((seg) => {
          const span = document.createElement("span");
          span.className = "transcript-chip " + (seg.type === "silence" ? "silence" : "");
          span.textContent = seg.text;
          span.dataset.id = String(seg.id);
          span.dataset.start = String(seg.start);
          span.dataset.end = String(seg.end);
          span.setAttribute("role", "button");
          span.setAttribute("tabindex", "0");
          span.setAttribute("aria-label", seg.type === "silence" ? "Silence " + seg.start + "–" + seg.end + "s. Click to remove from video." : seg.text + " " + seg.start + "–" + seg.end + "s. Click to remove from video.");
          span.addEventListener("click", () => toggleSegmentDeleted(seg.id));
          span.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              toggleSegmentDeleted(seg.id);
            }
          });
          transcriptEditor.appendChild(span);
          transcriptEditor.appendChild(document.createTextNode(" "));
        });
        rerenderBtn.disabled = true;
      }

      function toggleSegmentDeleted(id) {
        if (deletedIds.has(id)) {
          deletedIds.delete(id);
        } else {
          deletedIds.add(id);
        }
        updateChipStyles();
        rerenderBtn.disabled = deletedIds.size === 0;
      }

      function updateChipStyles() {
        transcriptEditor.querySelectorAll(".transcript-chip").forEach((el) => {
          const id = parseInt(el.dataset.id, 10);
          el.classList.toggle("deleted", deletedIds.has(id));
        });
      }

      async function loadTranscript(filename) {
        try {
          const res = await fetch("/get_transcript/" + encodeURIComponent(filename));
          const data = await res.json();
          if (res.ok && data.segments && data.segments.length) {
            renderTranscript(data.segments);
          } else {
            renderTranscript([]);
          }
        } catch (err) {
          renderTranscript([]);
        }
      }

      function onFileSelected(file) {
        const valid = validateFile(file);
        if (!valid) return;
        processVideo(valid);
      }

      dropzone.addEventListener("click", () => fileInput.click());
      dropzone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropzone.classList.add("dragover");
      });
      dropzone.addEventListener("dragleave", () => dropzone.classList.remove("dragover"));
      dropzone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropzone.classList.remove("dragover");
        const file = e.dataTransfer.files[0];
        if (file) onFileSelected(file);
      });
      fileInput.addEventListener("change", () => {
        const file = fileInput.files[0];
        if (file) onFileSelected(file);
        fileInput.value = "";
      });

      saveVttBtn.addEventListener("click", async () => {
        if (!currentFilename) return;
        try {
          const res = await fetch("/save_vtt/" + encodeURIComponent(currentFilename), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ vtt_content: vttEditor.value }),
          });
          const data = await res.json();
          if (res.ok) {
            setStatus("VTT saved.", "loading");
            setTimeout(clearStatus, 1500);
          } else {
            setStatus("Error: " + (data.error || "Save failed"), "error");
          }
        } catch (err) {
          setStatus("Error: " + err.message, "error");
        }
      });

      reprocessBtn.addEventListener("click", async () => {
        if (!currentFilename) return;
        setStatus("Re-processing…", "loading");
        reprocessBtn.disabled = true;
        try {
          const res = await fetch("/reprocess/" + encodeURIComponent(currentFilename), {
            method: "POST",
          });
          const data = await res.json();
          if (res.ok) {
            clearStatus();
            videoPreview.src = "/download/" + data.output_file;
          } else {
            setStatus("Error: " + (data.error || "Reprocess failed"), "error");
          }
        } catch (err) {
          setStatus("Error: " + err.message, "error");
        }
        reprocessBtn.disabled = false;
      });

      rerenderBtn.addEventListener("click", async () => {
        if (!currentFilename || deletedIds.size === 0) return;
        setStatus("Re-rendering video (cutting removed segments)…", "loading");
        rerenderBtn.disabled = true;
        try {
          const res = await fetch("/reprocess_edited/" + encodeURIComponent(currentFilename), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ deleted_ids: Array.from(deletedIds) }),
          });
          const data = await res.json();
          if (res.ok) {
            clearStatus();
            if (data.output_file) {
              videoPreview.src = "/download/" + data.output_file + "?t=" + Date.now();
            } else {
              setStatus("No cuts to apply.", "");
            }
          } else {
            setStatus("Error: " + (data.error || "Re-render failed"), "error");
          }
        } catch (err) {
          setStatus("Error: " + err.message, "error");
        }
        rerenderBtn.disabled = false;
      });
    </script>
  </body>
</html>
